<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teehee~ Steganography Web App</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { color-scheme: light dark; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(-45deg, #00c6ff, #0072ff, #00e7b7, #00a3ff); background-size: 300% 300%; animation: gradientShift 18s ease infinite; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; color: #1f2937; }
        .container { background: rgba(255,255,255,.9); backdrop-filter: blur(8px); border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,.25); max-width: 880px; width: 100%; padding: 40px; }
        h1 { text-align: center; margin-bottom: 10px; font-size: 2.5em; }
        .subtitle { text-align: center; color: #4b5563; margin-bottom: 40px; font-size: .95em; }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #f0f0f0; }
        .tab { padding: 12px 24px; cursor: pointer; background: none; border: none; font-size: 1.1em; color: #4b5563; transition: all .3s; border-bottom: 3px solid transparent; }
        .tab:hover { color: #2f62ff; }
        .tab.active { color: #2f62ff; border-bottom-color: #2f62ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn .3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @media (prefers-reduced-motion: reduce) { body { animation: none; } }
        .form-group { margin-bottom: 24px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; }
        input[type="text"], input[type="number"], textarea, input[type="file"] { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; transition: border-color .3s, background-color .3s, color .3s; background-color: rgba(255,255,255,.9); color: inherit; }
        input:focus, textarea:focus { outline: none; border-color: #2f62ff; }
        textarea { resize: vertical; min-height: 100px; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-input-wrapper input[type="file"] { position: absolute; left: -9999px; }
        .file-input-label { display: flex; align-items: center; justify-content: center; padding: 20px; border: 2px dashed #2f62ff; border-radius: 8px; cursor: pointer; transition: all .3s; color: #2f62ff; }
        .file-input-label:hover { background: rgba(47,98,255,.06); }
        .file-name { margin-top: 8px; font-size: .9em; color: #666; }
        button { width: 100%; padding: 14px; background: linear-gradient(135deg, #2f62ff 0%, #00a3ff 100%); color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all .3s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(47,98,255,.35); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .result { margin-top: 30px; padding: 20px; background: rgba(248,249,255,.9); border-radius: 8px; border-left: 4px solid #2f62ff; }
        .result h3 { margin-bottom: 12px; }
        /* Gradient text for headings (light) */
        h1, .result h3 {
            background: linear-gradient(135deg, #2f62ff 0%, #00a3ff 50%, #00e7b7 100%);
            -webkit-background-clip: text; background-clip: text; color: transparent;
        }
        .result-item { margin: 8px 0; color: #555; }
        .result-item strong { color: #333; }
        .download-link { display: inline-block; margin-top: 12px; padding: 10px 20px; background: #2f62ff; color: white; text-decoration: none; border-radius: 6px; transition: all .3s; }
        .download-link:hover { background: #254fd1; }
        .error { margin-top: 20px; padding: 15px; background: #fee; border-left: 4px solid #f44; border-radius: 8px; color: #c33; }
        .loading { text-align: center; padding: 20px; color: #2f62ff; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #2f62ff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .info-box { background: rgba(232,244,248,.9); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3; }
        .info-box p { margin: 5px 0; color: #555; font-size: .95em; }
        .lang-switch { position: fixed; top: 16px; right: 16px; z-index: 10; display: flex; gap: 8px; align-items: center; background: rgba(255,255,255,.85); backdrop-filter: blur(6px); border: 1px solid rgba(0,0,0,.06); border-radius: 10px; padding: 8px 12px; box-shadow: 0 4px 20px rgba(0,0,0,.12); }
        .lang-switch select { border: none; background: transparent; font-weight: 600; color: #444; outline: none; }
        .theme-select { border: none; background: transparent; font-weight: 600; color: #444; outline: none; }

        /* Dark theme (auto) */
        @media (prefers-color-scheme: dark) {
            body:not(.theme-light) { color: #e5e7eb; }
            body:not(.theme-light) { background: radial-gradient(1200px 800px at 10% 10%, rgba(0,180,255,.18), transparent 60%), radial-gradient(1000px 700px at 90% 90%, rgba(0,255,200,.12), transparent 55%), linear-gradient(-45deg, #0b1020, #0b132b, #111827, #0a0f1f); background-size: 300% 300%; animation: gradientShift 28s ease infinite; }
            body:not(.theme-light) .container { background: rgba(17,24,39,.7); box-shadow: 0 20px 60px rgba(0,0,0,.6); }
            body:not(.theme-light) h1 { color: transparent; }
            body:not(.theme-light) .subtitle { color: #b6c2d9; }
            body:not(.theme-light) .tabs { border-bottom-color: rgba(255,255,255,.06); }
            body:not(.theme-light) .tab { color: #cbd5e1; }
            body:not(.theme-light) .tab:hover, body:not(.theme-light) .tab.active { color: #93c5fd; border-bottom-color: #93c5fd; }
            body:not(.theme-light) label { color: #e5e7eb; }
            body:not(.theme-light) input[type="text"], body:not(.theme-light) input[type="number"], body:not(.theme-light) textarea { background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.12); color: #e5e7eb; }
            body:not(.theme-light) input:focus, body:not(.theme-light) textarea:focus { border-color: #60a5fa; }
            body:not(.theme-light) .file-input-label { border-color: #60a5fa; color: #60a5fa; }
            body:not(.theme-light) .file-input-label:hover { background: rgba(96,165,250,.12); }
            body:not(.theme-light) .result { background: rgba(30,41,59,.6); border-left-color: #60a5fa; }
            body:not(.theme-light) .result h3 { color: transparent; }
            /* Gradient text for headings (dark auto) */
            body:not(.theme-light) h1, body:not(.theme-light) .result h3 {
                background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 50%, #34d399 100%);
                -webkit-background-clip: text; background-clip: text; color: transparent;
            }
            body:not(.theme-light) .download-link { background: #3b82f6; }
            body:not(.theme-light) .download-link:hover { background: #2563eb; }
            body:not(.theme-light) .error { background: rgba(255,77,77,.08); border-left-color: #ef4444; color: #fca5a5; }
            body:not(.theme-light) .loading { color: #93c5fd; }
            body:not(.theme-light) .spinner { border-color: rgba(255,255,255,.12); border-top-color: #60a5fa; }
            body:not(.theme-light) .info-box { background: rgba(59,130,246,.1); border-left-color: #60a5fa; }
            body:not(.theme-light) .lang-switch { background: rgba(17,24,39,.7); border-color: rgba(255,255,255,.06); }
            body:not(.theme-light) .lang-switch select, body:not(.theme-light) .theme-select { color: #e5e7eb; }
        }

        /* Force themes via class */
        body.theme-dark { color: #e5e7eb; background: radial-gradient(1200px 800px at 10% 10%, rgba(0,180,255,.18), transparent 60%), radial-gradient(1000px 700px at 90% 90%, rgba(0,255,200,.12), transparent 55%), linear-gradient(-45deg, #0b1020, #0b132b, #111827, #0a0f1f); background-size: 300% 300%; animation: gradientShift 28s ease infinite; }
        body.theme-dark .container { background: rgba(17,24,39,.7); box-shadow: 0 20px 60px rgba(0,0,0,.6); }
        body.theme-dark h1 { color: transparent; }
        body.theme-dark .subtitle { color: #b6c2d9; }
        body.theme-dark .tabs { border-bottom-color: rgba(255,255,255,.06); }
        body.theme-dark .tab { color: #cbd5e1; }
        body.theme-dark .tab:hover, body.theme-dark .tab.active { color: #93c5fd; border-bottom-color: #93c5fd; }
        body.theme-dark label { color: #e5e7eb; }
        body.theme-dark input[type="text"], body.theme-dark input[type="number"], body.theme-dark textarea { background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.12); color: #e5e7eb; }
        body.theme-dark input:focus, body.theme-dark textarea:focus { border-color: #60a5fa; }
        body.theme-dark .file-input-label { border-color: #60a5fa; color: #60a5fa; }
        body.theme-dark .file-input-label:hover { background: rgba(96,165,250,.12); }
        body.theme-dark .result { background: rgba(30,41,59,.6); border-left-color: #60a5fa; }
        body.theme-dark .result h3 { color: transparent; }
        /* Gradient text for headings (dark forced) */
        body.theme-dark h1, body.theme-dark .result h3 {
            background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 50%, #34d399 100%);
            -webkit-background-clip: text; background-clip: text; color: transparent;
        }
        body.theme-dark .download-link { background: #3b82f6; }
        body.theme-dark .download-link:hover { background: #2563eb; }
        body.theme-dark .error { background: rgba(255,77,77,.08); border-left-color: #ef4444; color: #fca5a5; }
        body.theme-dark .loading { color: #93c5fd; }
        body.theme-dark .spinner { border-color: rgba(255,255,255,.12); border-top-color: #60a5fa; }
        body.theme-dark .info-box { background: rgba(59,130,246,.1); border-left-color: #60a5fa; }
        body.theme-dark .lang-switch { background: rgba(17,24,39,.7); border-color: rgba(255,255,255,.06); }
        body.theme-dark .lang-switch select, body.theme-dark .theme-select { color: #e5e7eb; }
    </style>
    <script nonce="{{ csp_nonce }}">
        const I18N = {
            en: {
                page_title: "Teehee~ Steganography Web App",
                brand: "Teehee Steganography",
                title: "Teehee~ Steganography",
                subtitle: "Secure image steganography service",
                tab_encrypt: "Encrypt",
                tab_decrypt: "Decrypt",
                tab_stats: "Stats",
                encrypt_info1: "Each run builds an isolated encryptor",
                encrypt_info2: "Compilation takes about 30â€“60 seconds",
                encrypt_info3: "Every build has its own secret, ensuring security",
                ttl_label: "TTL (seconds)",
                carrier_label: "Carrier image",
                choose_image: "ðŸ“ Choose image",
                secret_message_label: "Secret message",
                secret_message_placeholder: "Type the message to hide...",
                user_key_label: "User key (optional)",
                user_key_placeholder: "Optional extra secret key",
                encrypt_cta: "ðŸš€ Start encryption",
                decrypt_info1: "We will match the right decryptor by image fingerprint",
                decrypt_info2: "Works even for compressed images",
                stego_label: "Stego image",
                choose_stego_image: "ðŸ“ Choose stego image",
                decrypt_user_key_label: "User key (if used in encryption)",
                decrypt_user_key_placeholder: "Same key used for encryption",
                decrypt_cta: "ðŸ”“ Start decryption",
                stats_refresh: "ðŸ“Š Refresh stats",
                selected: "Selected:",
                loading: "Processing, please wait...",
                error_init_failed: "Initialization failed",
                error_encrypt_failed: "Encryption failed",
                error_upload_carrier_and_message: "Please upload a carrier image and input the message",
                error_upload_stego: "Please upload a stego image",
                error_decrypt_failed: "Decryption failed",
                error_stats_failed: "Failed to fetch stats",
                result_encrypt_title: "âœ… Encryption succeeded!",
                session_id: "Session ID:",
                compile_id: "Compile ID:",
                message_size: "Message size:",
                expires_at: "Expires at:",
                remaining_time: "Remaining:",
                bytes: "bytes",
                minutes: "minutes",
                download_stego: "ðŸ“¥ Download stego image",
                result_decrypt_title: "âœ… Decryption succeeded!",
                matched_distance: "Matched distance",
                hamming_distance: "Hamming distance",
                data_type: "Data type:",
                text: "Text",
                binary_base64: "Binary (Base64)",
                decrypted_message: "Decrypted message:",
                stats_title: "ðŸ“Š System stats",
                total_sessions: "Total sessions:",
                active_sessions: "Active sessions:",
                expired_sessions: "Expired sessions:",
                total_fingerprints: "Image fingerprints:"
            },
            zh: {
                page_title: "Teehee~ éšå†™æœ¯ Web åº”ç”¨",
                brand: "Teehee éšå†™æœ¯",
                title: "Teehee~ éšå†™æœ¯",
                subtitle: "ç»å¯¹å®‰å…¨çš„å›¾åƒåŠ å¯†è§£å¯†æœåŠ¡",
                tab_encrypt: "åŠ å¯†",
                tab_decrypt: "è§£å¯†",
                tab_stats: "ç»Ÿè®¡",
                encrypt_info1: "æ¯æ¬¡åŠ å¯†ä¼šåŠ¨æ€ç¼–è¯‘ä¸€ä¸ªç‹¬ç«‹çš„åŠ å¯†ç¨‹åº",
                encrypt_info2: "ç¼–è¯‘éœ€è¦çº¦ 30-60 ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…",
                encrypt_info3: "æ¯ä¸ªç¼–è¯‘æœ‰ç‹¬ç«‹çš„å¯†é’¥ï¼Œç¡®ä¿ç»å¯¹å®‰å…¨",
                ttl_label: "ç”Ÿå‘½å‘¨æœŸï¼ˆç§’ï¼‰",
                carrier_label: "è½½ä½“å›¾ç‰‡",
                choose_image: "ðŸ“ ç‚¹å‡»é€‰æ‹©å›¾ç‰‡",
                secret_message_label: "ç§˜å¯†æ¶ˆæ¯",
                secret_message_placeholder: "è¾“å…¥è¦éšè—çš„æ¶ˆæ¯...",
                user_key_label: "ç”¨æˆ·å¯†é’¥ï¼ˆå¯é€‰ï¼‰",
                user_key_placeholder: "å¯é€‰çš„é¢å¤–åŠ å¯†å¯†é’¥",
                encrypt_cta: "ðŸš€ å¼€å§‹åŠ å¯†",
                decrypt_info1: "ç³»ç»Ÿä¼šæ ¹æ®å›¾ç‰‡æŒ‡çº¹è‡ªåŠ¨åŒ¹é…æ­£ç¡®çš„è§£å¯†ç¨‹åº",
                decrypt_info2: "æ”¯æŒå¯¹åŽ‹ç¼©åŽçš„å›¾ç‰‡è¿›è¡Œè§£å¯†",
                stego_label: "éšå†™å›¾ç‰‡",
                choose_stego_image: "ðŸ“ ç‚¹å‡»é€‰æ‹©éšå†™å›¾ç‰‡",
                decrypt_user_key_label: "ç”¨æˆ·å¯†é’¥ï¼ˆå¦‚æžœåŠ å¯†æ—¶ä½¿ç”¨äº†ï¼‰",
                decrypt_user_key_placeholder: "ä¸ŽåŠ å¯†æ—¶ç›¸åŒçš„å¯†é’¥",
                decrypt_cta: "ðŸ”“ å¼€å§‹è§£å¯†",
                stats_refresh: "ðŸ“Š åˆ·æ–°ç»Ÿè®¡",
                selected: "å·²é€‰æ‹©:",
                loading: "å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...",
                error_init_failed: "åˆå§‹åŒ–å¤±è´¥",
                error_encrypt_failed: "åŠ å¯†å¤±è´¥",
                error_upload_carrier_and_message: "è¯·ä¸Šä¼ è½½ä½“å›¾ç‰‡å¹¶è¾“å…¥æ¶ˆæ¯",
                error_upload_stego: "è¯·ä¸Šä¼ éšå†™å›¾ç‰‡",
                error_decrypt_failed: "è§£å¯†å¤±è´¥",
                error_stats_failed: "èŽ·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥",
                result_encrypt_title: "âœ… åŠ å¯†æˆåŠŸï¼",
                session_id: "ä¼šè¯ ID:",
                compile_id: "ç¼–è¯‘ ID:",
                message_size: "æ¶ˆæ¯å¤§å°:",
                expires_at: "è¿‡æœŸæ—¶é—´:",
                remaining_time: "å‰©ä½™æ—¶é—´:",
                bytes: "å­—èŠ‚",
                minutes: "åˆ†é’Ÿ",
                download_stego: "ðŸ“¥ ä¸‹è½½éšå†™å›¾ç‰‡",
                result_decrypt_title: "âœ… è§£å¯†æˆåŠŸï¼",
                matched_distance: "åŒ¹é…è·ç¦»",
                hamming_distance: "æ±‰æ˜Žè·ç¦»",
                data_type: "æ•°æ®ç±»åž‹:",
                text: "æ–‡æœ¬",
                binary_base64: "äºŒè¿›åˆ¶ (Base64)",
                decrypted_message: "è§£å¯†æ¶ˆæ¯:",
                stats_title: "ðŸ“Š ç³»ç»Ÿç»Ÿè®¡",
                total_sessions: "æ€»ä¼šè¯æ•°:",
                active_sessions: "æ´»è·ƒä¼šè¯:",
                expired_sessions: "è¿‡æœŸä¼šè¯:",
                total_fingerprints: "å›¾ç‰‡æŒ‡çº¹æ•°:"
            }
        };

        let currentLang = (localStorage.getItem('lang') || 'en');
        function t(key) { return (I18N[currentLang] && I18N[currentLang][key]) || key; }
        function applyI18n(root = document) {
            document.title = t('page_title');
            document.documentElement.lang = currentLang === 'zh' ? 'zh-CN' : 'en';
            root.querySelectorAll('[data-i18n]').forEach(el => { el.textContent = t(el.getAttribute('data-i18n')); });
            root.querySelectorAll('[data-i18n-placeholder]').forEach(el => { const k = el.getAttribute('data-i18n-placeholder'); el.setAttribute('placeholder', t(k)); });
        }

        const csrfToken = document.currentScript.ownerDocument.querySelector('meta[name="csrf-token"]').content;
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
            const targetBtn = document.querySelector(`.tab[data-tab="${tab}"]`);
            if (targetBtn) targetBtn.classList.add('active');
        }
        function setText(id, text) { const el = document.getElementById(id); if (el) el.textContent = text; }
        function showLoading(elementId) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            const div = document.createElement('div');
            div.className = 'loading';
            const spinner = document.createElement('div');
            spinner.className = 'spinner';
            const p = document.createElement('p');
            p.textContent = t('loading');
            div.appendChild(spinner); div.appendChild(p); container.appendChild(div);
        }
        function showError(elementId, message) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            const div = document.createElement('div');
            div.className = 'error';
            div.textContent = `âŒ ${message}`;
            container.appendChild(div);
        }
        function fillFromTemplate(tplId, targetId, mapping) {
            const tpl = document.getElementById(tplId);
            const node = tpl.content.cloneNode(true);
            Object.entries(mapping).forEach(([key, value]) => {
                const field = node.querySelector(`[data-field="${key}"]`);
                if (!field) return;
                if (field.tagName === 'TEXTAREA' || field.tagName === 'INPUT') field.value = value; else field.textContent = value;
                if (key === 'download_href' && field.tagName === 'A') field.setAttribute('href', value);
            });
            applyI18n(node);
            const container = document.getElementById(targetId);
            container.innerHTML = '';
            container.appendChild(node);
        }
        async function postJson(url, data) {
            const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken }, body: JSON.stringify(data) });
            return res;
        }
        async function postForm(url, formData) {
            const res = await fetch(url, { method: 'POST', headers: { 'X-CSRF-Token': csrfToken }, body: formData });
            return res;
        }
        function applyTheme(theme) {
            document.body.classList.remove('theme-dark', 'theme-light');
            if (theme === 'dark') document.body.classList.add('theme-dark');
            if (theme === 'light') document.body.classList.add('theme-light');
        }
        window.addEventListener('DOMContentLoaded', () => {
            // init language select
            const langSelect = document.getElementById('lang-select');
            if (langSelect) {
                langSelect.value = currentLang;
                langSelect.addEventListener('change', () => {
                    currentLang = langSelect.value;
                    localStorage.setItem('lang', currentLang);
                    applyI18n();
                });
            }
            applyI18n();
            // init theme select
            const themeSelect = document.getElementById('theme-select');
            const savedTheme = localStorage.getItem('theme') || 'system';
            themeSelect && (themeSelect.value = savedTheme);
            applyTheme(savedTheme);
            themeSelect?.addEventListener('change', () => {
                const theme = themeSelect.value;
                localStorage.setItem('theme', theme);
                applyTheme(theme);
            });
            // Bind tabs click without inline handlers (CSP-safe)
            document.querySelectorAll('.tab[data-tab]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.getAttribute('data-tab');
                    if (tab) switchTab(tab);
                });
            });
            const carrierInput = document.getElementById('carrier-image');
            const stegoInput = document.getElementById('stego-image');
            const encryptBtn = document.getElementById('encrypt-btn');
            const decryptBtn = document.getElementById('decrypt-btn');
            const statsBtn = document.getElementById('refresh-stats');

            carrierInput?.addEventListener('change', () => {
                const name = carrierInput.files?.[0]?.name || '';
                setText('carrier-name', name ? `${t('selected')} ${name}` : '');
            });
            stegoInput?.addEventListener('change', () => {
                const name = stegoInput.files?.[0]?.name || '';
                setText('stego-name', name ? `${t('selected')} ${name}` : '');
            });

            encryptBtn?.addEventListener('click', async () => {
                const ttl = parseInt(document.getElementById('ttl').value, 10);
                const carrierFile = carrierInput?.files?.[0];
                const message = document.getElementById('message').value;
                const userKey = document.getElementById('user-key').value;
                if (!carrierFile || !message) { showError('encrypt-result', t('error_upload_carrier_and_message')); return; }
                showLoading('encrypt-result');
                try {
                    const initRes = await postJson('/api/encrypt/init', { ttl_seconds: ttl });
                    if (!initRes.ok) { const err = await initRes.json().catch(() => ({})); throw new Error(err.error || t('error_init_failed')); }
                    const initData = await initRes.json();
                    const formData = new FormData();
                    formData.append('session_id', initData.session_id);
                    formData.append('message', message);
                    formData.append('carrier_image', carrierFile);
                    if (userKey) formData.append('user_key', userKey);
                    const embedRes = await postForm('/api/encrypt/embed', formData);
                    if (!embedRes.ok) { const err = await embedRes.json().catch(() => ({})); throw new Error(err.error || t('error_encrypt_failed')); }
                    const embedData = await embedRes.json();
                    const mapping = {
                        session_id: initData.session_id,
                        compile_id: initData.compile_id,
                        message_size: embedData.message_size,
                        expires_at: new Date(initData.expires_at).toLocaleString(),
                        remaining_minutes: Math.floor((initData.remaining_seconds || 0) / 60),
                        download_href: embedData.stego_image_url
                    };
                    fillFromTemplate('result-success-encrypt', 'encrypt-result', mapping);
                } catch (e) { showError('encrypt-result', e.message || String(e)); }
            });

            decryptBtn?.addEventListener('click', async () => {
                const stegoFile = stegoInput?.files?.[0];
                const userKey = document.getElementById('decrypt-user-key').value;
                if (!stegoFile) { showError('decrypt-result', t('error_upload_stego')); return; }
                showLoading('decrypt-result');
                try {
                    const formData = new FormData();
                    formData.append('stego_image', stegoFile);
                    if (userKey) formData.append('user_key', userKey);
                    const res = await postForm('/api/decrypt', formData);
                    if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.error || t('error_decrypt_failed')); }
                    const data = await res.json();
                    const mapping = {
                        compile_id: data.compile_id,
                        matched_distance: data.matched_distance,
                        is_binary: data.is_binary ? t('binary_base64') : t('text'),
                        message: data.message
                    };
                    fillFromTemplate('result-success-decrypt', 'decrypt-result', mapping);
                } catch (e) { showError('decrypt-result', e.message || String(e)); }
            });

            statsBtn?.addEventListener('click', async () => {
                showLoading('stats-result');
                try {
                    const res = await fetch('/api/stats');
                    if (!res.ok) throw new Error(t('error_stats_failed'));
                    const data = await res.json();
                    const div = document.createElement('div');
                    div.className = 'result';
                    div.innerHTML = `<h3>${t('stats_title')}</h3>
                        <div class="result-item"><strong>${t('total_sessions')}</strong> ${data.total_sessions}</div>
                        <div class="result-item"><strong>${t('active_sessions')}</strong> ${data.active_sessions}</div>
                        <div class="result-item"><strong>${t('expired_sessions')}</strong> ${data.expired_sessions}</div>
                        <div class="result-item"><strong>${t('total_fingerprints')}</strong> ${data.total_fingerprints}</div>`;
                    const container = document.getElementById('stats-result');
                    container.innerHTML = '';
                    container.appendChild(div);
                } catch (e) { showError('stats-result', e.message || String(e)); }
            });
        });
    </script>
</head>
<body>
    <div class="lang-switch">
        <select id="lang-select" aria-label="Language">
            <option value="en">English</option>
            <option value="zh">ä¸­æ–‡</option>
        </select>
        <select id="theme-select" class="theme-select" aria-label="Theme">
            <option value="system">System</option>
            <option value="light">Light</option>
            <option value="dark">Dark</option>
        </select>
    </div>
    {% block content %}{% endblock %}
</body>
</html>

