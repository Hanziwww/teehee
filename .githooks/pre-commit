#!/bin/sh
#
# Pre-commit hook - ä¸ GitHub CI æµæ°´çº¿å¯¹é½
# åœ¨æäº¤å‰è‡ªåŠ¨è¿è¡Œæ ¼å¼åŒ–ã€Clippy å’Œæµ‹è¯•
#
# å®‰è£…æ–¹æ³•ï¼š
#   git config core.hooksPath .githooks
#

set -e

echo "ğŸ” è¿è¡Œ pre-commit æ£€æŸ¥..."
echo ""

# 1. ä»£ç æ ¼å¼æ£€æŸ¥
echo "ğŸ“ [1/5] æ£€æŸ¥ä¸»é¡¹ç›®ä»£ç æ ¼å¼..."
if ! cargo fmt --all -- --check; then
    echo ""
    echo "âŒ ä¸»é¡¹ç›®ä»£ç æ ¼å¼ä¸ç¬¦åˆè§„èŒƒï¼"
    echo "ğŸ’¡ è¿è¡Œä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨æ ¼å¼åŒ–ï¼š"
    echo "   cargo fmt --all"
    exit 1
fi
echo "âœ… ä¸»é¡¹ç›®æ ¼å¼æ£€æŸ¥é€šè¿‡"
echo ""

echo "ğŸ“ [2/5] æ£€æŸ¥ Web é¡¹ç›®ä»£ç æ ¼å¼..."
if ! cargo fmt --all --manifest-path web/Cargo.toml -- --check; then
    echo ""
    echo "âŒ Web é¡¹ç›®ä»£ç æ ¼å¼ä¸ç¬¦åˆè§„èŒƒï¼"
    echo "ğŸ’¡ è¿è¡Œä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨æ ¼å¼åŒ–ï¼š"
    echo "   cargo fmt --all --manifest-path web/Cargo.toml"
    exit 1
fi
echo "âœ… Web é¡¹ç›®æ ¼å¼æ£€æŸ¥é€šè¿‡"
echo ""

# 2. Clippy ä»£ç æ£€æŸ¥
echo "ğŸ”§ [3/5] è¿è¡Œä¸»é¡¹ç›® Clippy ä»£ç æ£€æŸ¥..."
if ! cargo clippy --all-targets --all-features -- -D warnings; then
    echo ""
    echo "âŒ ä¸»é¡¹ç›® Clippy æ£€æŸ¥å¤±è´¥ï¼"
    echo "ğŸ’¡ è¯·ä¿®å¤ä¸Šè¿°è­¦å‘Šåå†æäº¤"
    exit 1
fi
echo "âœ… ä¸»é¡¹ç›® Clippy æ£€æŸ¥é€šè¿‡"
echo ""

echo "ğŸ”§ [4/5] è¿è¡Œ Web é¡¹ç›® Clippy ä»£ç æ£€æŸ¥..."
if ! cargo clippy --all-targets --all-features --manifest-path web/Cargo.toml -- -D warnings; then
    echo ""
    echo "âŒ Web é¡¹ç›® Clippy æ£€æŸ¥å¤±è´¥ï¼"
    echo "ğŸ’¡ è¯·ä¿®å¤ä¸Šè¿°è­¦å‘Šåå†æäº¤"
    exit 1
fi
echo "âœ… Web é¡¹ç›® Clippy æ£€æŸ¥é€šè¿‡"
echo ""

# 3. è¿è¡Œæµ‹è¯•
echo "ğŸ§ª [5/5] è¿è¡Œæ‰€æœ‰æµ‹è¯•..."
if ! cargo test --quiet; then
    echo ""
    echo "âŒ ä¸»é¡¹ç›®æµ‹è¯•å¤±è´¥ï¼"
    echo "ğŸ’¡ è¯·ä¿®å¤æµ‹è¯•åå†æäº¤"
    exit 1
fi
if ! cargo test --quiet --manifest-path web/Cargo.toml; then
    echo ""
    echo "âŒ Web é¡¹ç›®æµ‹è¯•å¤±è´¥ï¼"
    echo "ğŸ’¡ è¯·ä¿®å¤æµ‹è¯•åå†æäº¤"
    exit 1
fi
echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡"
echo ""

echo "ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼å‡†å¤‡æäº¤..."
echo ""

